# {{ ansible_managed }}
[Unit]
Description=Borg backup run
After=network.target
RequiresMountsFor={{ borg_repository }}

[Service]
Type=oneshot
{% if not borg_error_on_warn %}
# Exit status 1 means warning and we're ok with that
# https://borgbackup.readthedocs.io/en/stable/usage/general.html#return-codes
SuccessExitStatus=1
{% endif %}
ExecStart={{ borg_binary_location }} create --verbose --stats \
	--exclude-caches \
	--exclude-from /root/.borg/exclusions.conf \
	--compression "{{ borg_compression }}" \
	"{{ borg_repository }}::backup-{now:%%Y-%%m-%%d_%%H:%%M:%%S}" /
{{ 'ExecStopPost' if borg_always_cleanup else 'ExecStartPost' }}={{ borg_binary_location }} prune -v --list \
	"--keep-within={{ borg_prune_keep_within }}" \
	"--keep-daily={{ borg_prune_keep_daily }}" \
	"--keep-weekly={{ borg_prune_keep_weekly }}" \
	"--keep-monthly={{ borg_prune_keep_monthly }}" \
	"--keep-yearly={{ borg_prune_keep_yearly }}"
EnvironmentFile=/root/.borg/passphrase

# It's no priority
Nice=19
IOSchedulingClass=2
IOSchedulingPriority=7
